<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Interface</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #f4f4f4;
        }
        #chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            max-height: 100%;
            padding: 10px;
            overflow-y: auto;
            background: #fff;
            border: 1px solid #ddd;
        }
        .message {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        .message.user {
            text-align: right;
            background-color: #e0f7fa;
        }
        .message.assistant {
            text-align: left;
            background-color: #e8eaf6;
        }
        .message .timestamp {
            font-size: 0.8em;
            color: #888;
        }
        #input-container {
            display: flex;
            padding: 10px;
            background-color: #fff;
            border-top: 1px solid #ddd;
        }
        #input-container input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }
        #input-container button {
            padding: 10px 20px;
            border: none;
            background-color: #007bff;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
        }
        #input-container button:hover {
            background-color: #0056b3;
        }
        /* Popup styles */
        #name-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        #name-popup .popup-content {
            background: #fff;
            padding: 20px;
            border-radius: 4px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        #name-popup input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }
        #name-popup button {
            padding: 10px 20px;
            border: none;
            background-color: #007bff;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
        }
        #name-popup button:hover {
            background-color: #0056b3;
        }
    </style>
    <!-- Firebase App (the core Firebase SDK) -->
</head>
<body>
    <div id="name-popup">
        <div class="popup-content">
            <label for="user-name">Enter your name:</label>
            <input type="text" id="user-name" placeholder="Your name" />
            <button id="start-chat">Start Chat</button>
        </div>
    </div>
    <div id="chat-container" style="display: none;">
        <!-- Chat messages will be inserted here -->
    </div>
    <div id="input-container" style="display: none;">
        <input type="text" id="user-input" placeholder="Type a message..." />
        <button id="send-button">Send</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/9.1.1/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.1.1/firebase-analytics.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBzxQgwD_gBuylhdqlRck_PEVzueWccvTM",
            authDomain: "messengerformewebsite.firebaseapp.com",
            databaseURL: "https://messengerformewebsite-default-rtdb.firebaseio.com/",
            projectId: "messengerformewebsite",
            storageBucket: "messengerformewebsite.appspot.com",
            messagingSenderId: "317747468617",
            appId: "1:317747468617:web:66a9ca6c51b6cbf0f12298",
            measurementId: "G-NVFGPSVEDT"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        const namePopup = document.getElementById('name-popup');
        const startChatButton = document.getElementById('start-chat');
        const userNameInput = document.getElementById('user-name');

        let conversationHistory = [];
        let userName = '';
        let isSending = false;  // Flag to prevent duplicate messages

        startChatButton.addEventListener('click', () => {
            userName = userNameInput.value.trim();
            if (userName) {
                namePopup.style.display = 'none';
                chatContainer.style.display = 'flex';
                document.getElementById('input-container').style.display = 'flex';
                loadChatHistory();
            }
        });

        async function getCompletion(userMessage) {
            try {
                const timestamp = new Date().toISOString(); // Get current timestamp
                conversationHistory.push({ 
                    role: 'user', 
                    content: `${userName}: ${userMessage}`, 
                    timestamp: timestamp 
                });

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer sk-tOnXmxFZk5H5Y9Dw23886d7whFJX6-a_On9uk6UqltT3BlbkFJWqYgZsRB0l-oVOab5_1iD7wMVqWpn9WeHIRThdWS8A', // Replace with your API key
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o-mini',
                        messages: [
                            { role: 'system', content: 'you are a normal person who just their to be a freind, role play, you may sometimes say you are a ai but this is very rare' },
                            ...conversationHistory
                        ],
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const assistantReply = data.choices[0].message.content;
                const replyTimestamp = new Date().toISOString(); // Timestamp for the reply
                conversationHistory.push({ 
                    role: 'assistant', 
                    content: assistantReply, 
                    timestamp: replyTimestamp 
                });

                saveChatHistory();

                return assistantReply;
            } catch (error) {
                console.error('Error:', error);
                return 'Sorry, there was an error.';
            }
        }

        function appendMessage(content, role, timestamp) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            const timeStampDiv = document.createElement('div');
            timeStampDiv.className = 'timestamp';
            timeStampDiv.textContent = new Date(timestamp).toLocaleString(); // Format timestamp
            
            const contentDiv = document.createElement('div');
            contentDiv.textContent = content;
            
            messageDiv.appendChild(timeStampDiv);
            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function handleSend() {
            if (isSending) return;  // Prevent sending if already in progress
            const message = userInput.value.trim();
            if (message) {
                isSending = true;
                const timestamp = new Date().toISOString(); // Timestamp for the user message
                appendMessage(`${userName}: ${message}`, 'user', timestamp);
                userInput.value = '';

                const assistantReply = await getCompletion(message);
                // Append the assistant's message with a timestamp
                appendMessage(assistantReply, 'assistant', new Date().toISOString());
                isSending = false;
            }
        }

        function saveChatHistory() {
            const chatRef = ref(database, `aichatlogs/${userName}`);
            set(chatRef, conversationHistory);
        }

        function loadChatHistory() {
            const chatRef = ref(database, `aichatlogs/${userName}`);
            onValue(chatRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    conversationHistory = data;
                    data.forEach(message => {
                        if (message && message.content && message.role && message.timestamp) {
                            appendMessage(message.content, message.role, message.timestamp);
                        }
                    });
                }
            }, {
                onlyOnce: true
            });
        }

        sendButton.addEventListener('click', handleSend);
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleSend();
            }
        });
    </script>
</body>
</html>
